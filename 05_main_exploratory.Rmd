---
title: "Main exploratory analysis"
author: "Luis"
date: "03/2022"
output: html_document
---
## Full Model:
# CDI vocabulary ~  ids_pref:test_age + ids_pref:cdi_age + ids_pref:protocol + ids_pref + cdi_age + gender + (1 + ids_pref:test_age + ids_pref:cdi_age + ids_pref:protocol + ids_pref + cdi_age + gender | lab)
## Pruned Model:
# CDI_vocabulary ~  ids_pref:test_age + ids_pref:cdi_age + ids_pref:protocol + ids_pref + cdi_age + gender + protocol + test_age + (1 | lab) + (1| participant)
```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "")
```

```{r libraries, echo = FALSE, include = FALSE}
library(dplyr)
library(glmmTMB)
```

```{r preprocessing}
rm(list = ls())

# Load data from a .txt file
imported <- read.delim("data/cdi_percentile/percentiles_manybabies_cdi.txt", stringsAsFactors = TRUE, header = TRUE) 

data <- tibble(vocabulary_percentile = imported$daily_percentile, ids_pref = imported$IDS_pref, test_age = imported$age_days, cdi_age = imported$CDI.agedays, protocol = imported$method, gender = imported$gender, lab = imported$labid, participant = imported$subid_unique, nae = imported$nae)
#noticed that for subid_unique there are still some subjects that have the same id.

#investigate the distribution of each variable
hist(data$vocabulary_percentile) #evenly distributed

hist(data$ids_pref) #normally distributed

hist(data$test_age) #normally distributed

hist(data$cdi_age) #bimodal distribution

plot(data$protocol) # head-turn preference design is most prevalent.

plot(data$gender) # roughly equal numbers of each gender

plot(data$lab) # fairly large variance in numbers from each lab

plot(data$participant) # some infants seem to have been tested multiple times

plot(table(data$nae)) # few more non-nae

#z transformation of the predictors to help with the interpretation of the model.
data$z.ids_pref <- as.vector(scale(data$ids_pref))
data$z.test_age <- as.vector(scale(data$test_age))

#ensuring the response variable is between 0 and 1, as is required for a beta error model.
data$vocabulary_percentile[data$vocabulary_percentile == 0] <- 1
if(data$vocabulary_percentile > 1)
{
  data$vocabulary_percentile <- data$vocabulary_percentile/100
}

#Running the mixed effects model with a beta error distribution for the response variable.
full=glmmTMB(vocabulary_percentile ~ ids_pref*test_age + ids_pref*cdi_age + ids_pref*protocol + gender +(1 | lab) + (1| participant), family=beta_family(link="logit"), data=data)

summary(full)
```

