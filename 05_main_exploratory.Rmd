---
title: "Main exploratory analysis"
author: "Luis"
date: "03/2022"
output: html_document
---
## Full Model (This model was not used in the analyses):
# CDI vocabulary ~  ids_pref:age_days + ids_pref:CDI.agedays + ids_pref:method + ids_pref + CDI.agedays + gender + (1 + ids_pref:age_days + ids_pref:CDI.agedays + ids_pref:method + ids_pref + CDI.agedays + gender | labid)
## Pruned Model (only this model was tested in the analyses):
# CDI_vocabulary ~  ids_pref:age_days + ids_pref:CDI.agedays + ids_pref:method + ids_pref + CDI.agedays + gender + method + age_days + ids_pref : nae + nae + (1 | labid) + (1| subid_unique)
```{r setup, echo = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, include = FALSE)
```

```{r libraries, echo = FALSE, include = FALSE}
library(dplyr)
library(glmmTMB)
library(ggplot2)
library(lmtest)
library(rstatix)
library(sjPlot)
library(rstudioapi) 
```

```{r preprocessing, echo = TRUE, include = TRUE, warning = FALSE}
rm(list = ls())
# Always start by setting the current directory to the directory of this script file.
setwd(dirname(getActiveDocumentContext()$path))
source("glmmTMB_stability.r")
source("diagnostic_fcns.r")
# Load data from a .txt file
imported <- read.delim("data/cdi_percentile/percentiles_manybabies_cdi.txt", stringsAsFactors = TRUE, header = TRUE) 

# Data set that will be used for the analyses.
data <- data.frame(daily_percentile = imported$daily_percentile, IDS_pref = imported$IDS_pref, age_days = imported$age_days, CDI.agedays = imported$CDI.agedays, method = imported$method, gender = imported$gender, labid = imported$labid, subid_unique = imported$subid_unique, nae = imported$nae, vocab_nwords = imported$vocab_nwords, CDI.agerange = imported$CDI.agerange)

# These are only used to understand the distribution of each variable.
hist(data$daily_percentile, breaks = 100)
hist(data$IDS_pref)
hist(data$age_days)
hist(data$CDI.agedays)
plot(data$method)
plot(data$gender)
plot(data$labid)
plot(data$subid_unique)
plot(table(data$nae))

# Ensuring the value is a factor because it is a categorical variable.
data$CDI.agerange <- as.factor(data$CDI.agerange)

# Ensuring the response variable is between 0 and 1, as is required for a beta error model.
data$daily_percentile[data$daily_percentile == 0] <- 1

if(any(data$daily_percentile > 1))
{
  data$daily_percentile <- data$daily_percentile / 100
}

#get the data with all NA values removed.
full.fe.re <- fe.re.tab(fe.model = "daily_percentile ~ IDS_pref * age_days + IDS_pref * CDI.agerange + IDS_pref * method + IDS_pref * nae + gender", re = c("labid", "subid_unique"), data = data)
t.data <- full.fe.re$data

#z transformation of the predictors to help with the interpretation of the model.
t.data$z.IDS_pref <- as.vector(scale(t.data$IDS_pref))
t.data$z.age_days <- as.vector(scale(t.data$age_days))

#Running the mixed effects model with a beta error distribution for the response variable.
full <- glmmTMB(daily_percentile ~ z.IDS_pref * z.age_days + z.IDS_pref * CDI.agerange + z.IDS_pref * method + z.IDS_pref * nae + gender + (1 |labid) + (1 | subid_unique), family = beta_family(link = "logit"), data = t.data)

#Checking the assumption that variance and the mean are linked. It was met with this model.
overdisp.test(full)

#Best Linear Unbiased Predictors: the estimated deviations of intercepts and slopes from the respective common average, per level of the random effects.
ranef.diagn.plot(full) #The random effects appear normally distributed.

#Test for collinearity between the predictors. There are no signs of collinearity.
coll_model <- lm(daily_percentile ~ z.IDS_pref + z.age_days + CDI.agerange + method + nae + gender, data = t.data)
library(car)
vif(coll_model)

#Test for stability by dropping levels of the random effects one at a time and comparing the estimates derived from models fitted on the respective subsets with those obtained for the full
# data set. There don't seem to be major issues with the stability of the model coefficients.
# Takes a while to run
full.stab <- glmmTMB.stab(model.res = full, para = TRUE, data = t.data)
table(full.stab$detailed$converged)
m.stab.plot(full.stab$summary[, -1])

# The same structure as the full model but removes the key variable of interest "IDS_pref" and all its interacting terms.
# This will help control for the multitude of possible models that we could run with this term and if this model is found to be 
# statistically significantly different from the full model, that suggests "IDS_pref" is associated with daily_percentile. 
null <- glmmTMB(daily_percentile ~ z.age_days + CDI.agerange + method + nae + gender + (1 | labid) + (1 | subid_unique), family = beta_family(link = "logit"), data = t.data)

# full - null model comparison reveals that the effect of z.IDS_pref doesn't significantly improve the model fit.
as.data.frame(anova(null, full, test="Chisq"))

summary(full)
```

